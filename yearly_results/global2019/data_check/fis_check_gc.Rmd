---
title: "Understanding 2019 Fisheries scores and underlying data"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
  pdf_document:
    toc: true
---

# Summary of questions concerning fisheries
 - Why is Peru so high?
 - Why are these islands off of Eastern Africa doing comparatively well for FIS?
 - Falkland Islands off of Argentina have had a drop in fis scores. Why?
 - Dive into countries that are increasing/decreasing over time and explore. 


```{r setup, include=FALSE, message = F, warning = F}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)

library(tidyverse)
source('http://ohi-science.org/ohiprep_v2019/workflow/R/common.R')
```

# Look at scores over time

Pick Peru (138), Falkland Islands (95), Comoro Islands (28), Mayotte (29), Reunion (32), Mauritius (37), Seychelles (31), Madagascar (42) to examine for first three questions. 

```{r}
#scores data
scores <- read_csv("../scores_2019-10-30.csv") %>%
  filter(goal == "FIS")

scores_2018 <- read_csv(file.path(here(), "yearly_results/global2018/scores_2018-11-28.csv")) %>%
  filter(goal == "FIS")

#region details to help us filter by country name rather than ID
rgn_deets <- read_csv("https://raw.github.com/OHI-Science/ohiprep_v2018/gh-pages/globalprep/supplementary_information/v2018/rgn_details.csv")

#pull out some specific countries
region_data()
ctry_data <- scores %>%
  left_join(rgns_all, by = c("region_id" = "rgn_id")) %>%
  filter(rgn_name %in% c("Peru", "Falkland Islands", "Comoro Islands", "Mayotte", "Reunion", "Mauritius", "Seychelles", "Madagascar"))

ctry_data_2018 <- scores_2018 %>%
  left_join(rgns_all, by = c("region_id" = "rgn_id")) %>%
  filter(rgn_name %in% c("Peru", "Falkland Islands", "Comoro Islands", "Mayotte", "Reunion", "Mauritius", "Seychelles", "Madagascar"))

```

Plot these countries 

```{r}
score <- ctry_data %>%
  filter(dimension == "score")

# look at the east african countries
score %>% filter(rgn_name %in% c("Comoro Islands", "Mayotte", "Reunion", "Mauritius", "Seychelles", "Madagascar")) %>%
  ggplot(aes(x = year, y = score, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(y = "FIS score") +
  theme(legend.title=element_blank())

# Take a look at Peru and Falkland Islands 
score %>% filter(rgn_name %in% c("Peru", "Falkland Islands")) %>%
  ggplot(aes(x = year, y = score, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(y = "FIS score") +
  theme(legend.title=element_blank())

```

```{r}
# check out the same plots compared to last years assessment data... 
score_2018 <- ctry_data_2018 %>%
  filter(dimension == "score")

# look at the east african countries
score_2018 %>% filter(rgn_name %in% c("Comoro Islands", "Mayotte", "Reunion", "Mauritius", "Seychelles", "Madagascar")) %>%
  ggplot(aes(x = year, y = score, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(y = "FIS score") +
  theme(legend.title=element_blank())

# Take a look at Peru and Falkland Islands 
score_2018 %>% filter(rgn_name %in% c("Peru", "Falkland Islands")) %>%
  ggplot(aes(x = year, y = score, color = rgn_name)) +
  geom_line() +
  theme_bw() +
  labs(y = "FIS score") +
  theme(legend.title=element_blank())
```



Interesting that all of the East African Islands generally follow the same pattern (at varying levels of scores). Peru and The Falkland Islands are strikingly different. Peru is likely due to anchovies, but the Falkland Islands are a cause for concern as their scores have dropped steadily every year. The differences between the 2018 and 2019 assessment years are striking, probably due to the drastic changes in the watson data we obtained this year. 


```{r}

t <- ctry_data %>%
  filter(dimension %in% c("pressures", "status", "resilience"))

ggplot(t, aes(x = year, y = score, color = dimension)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~rgn_name) +
  theme(legend.title=element_blank())

t_2018 <- ctry_data_2018 %>%
  filter(dimension %in% c("pressures", "status", "resilience"))

ggplot(t_2018, aes(x = year, y = score, color = dimension)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~rgn_name) +
  theme(legend.title=element_blank())

```

It looks like pressures and resilience are not having a big impact on these status values. Next things to look at is catch over time and stock scores with proportional catch over time.

Looking at b/bmsy and catch data

```{r}
bbmsy <- read_csv("~/github/ohi-global/eez/layers/fis_b_bmsy.csv") %>%
  filter(rgn_id %in% unique(ctry_data$region_id)) %>%
  mutate(group = 
           case_when(
             bbmsy < 0.8 ~ "overfished",
             bbmsy >= 0.8 & bbmsy <= 1.45 ~ "fully exploited",
             bbmsy > 1.45 ~ "underfished"
           ))

catch <- read_csv("~/github/ohi-global/eez/layers/fis_meancatch.csv") %>%
  filter(rgn_id %in% unique(ctry_data$region_id)) %>%
  separate(stock_id_taxonkey, into = c("stock_id", "taxonkey"), sep = "_(?=[:digit:])")

combine <- bbmsy %>% 
  full_join(catch) %>%
  group_by(rgn_id, group, year) %>%
  summarize(catch = sum(mean_catch, na.rm=T)) %>%
  left_join(rgns_all) %>%
  select(year, rgn_name, group, catch) %>%
  distinct() %>%
  mutate(status = ifelse(is.na(group), "no status", group)) %>%
  filter(year > 2008)


ggplot(combine, aes(year, catch)) + 
  geom_area(aes(fill = status)) +
  facet_wrap(~rgn_name, scales = "free") +
  scale_fill_manual(breaks = c("fully exploited", "no status", "overfished", "underfished"), 
                       values=c("darkblue", "orange", "darkred", "darkgreen")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


What stocks are making up Peru's catch?

```{r}
pr <- catch %>% 
  filter(rgn_id == 138,
         year > 2008) %>%
  left_join(bbmsy) %>%
  group_by(year) %>%
  mutate(catch_prop = mean_catch/sum(mean_catch))

plotly::ggplotly(ggplot(pr, aes(year, catch_prop)) + 
  geom_area(aes(fill = stock_id)) +
  theme_bw() +
  theme(legend.position=""))

```


It looks like *Engraulis_ringens-87* makes up a significant portion of the catch! Almost 60% of catch. This is a **Peruvian anchoveta**

```{r}
anchoveta_bbmsy <- bbmsy %>%
  filter(stock_id == "Engraulis_ringens-87")

ggplot(anchoveta_bbmsy, aes(x = year, y = bbmsy)) +
  geom_line() +
  theme_bw() +
  geom_hline(yintercept = 1.45, color = "darkgreen", lty = "dashed") +
  ylab("B/Bmsy") +
  xlab("Year") +
  ggtitle("Peruvian Anchoveta FAO Area 87")

```

This is one of the largest fisheries in the world. And the status has been getting closer to 1 so it improves the score. The dashed green line shows where we define underexploted (>1.45) and fully exploited (<1.45) which explains the status of Peru getting better.


Let's see what's going on with Falkland Islands 

```{r}
fl <- catch %>% 
  filter(rgn_id == 95,
         year > 2008) %>%
  left_join(bbmsy) %>%
  group_by(year) %>%
  mutate(catch_prop = mean_catch/sum(mean_catch))

plotly::ggplotly(ggplot(fl, aes(year, catch_prop)) + 
  geom_area(aes(fill = stock_id)) +
  theme_bw() +
  theme(legend.position=""))
```

Illex_argentinus-41
Loligo_gahi-41

Again, we have one species (Illex_argentinus-41) making up nearly 60% of the catch. The common name for this is **Argentine Shortfin Squid**. We also have another species making up 27% of the catch. This is Loligo_gahi-41, common name Patagonian Squid. 

```{r}
argen_bbmsy <- bbmsy %>%
  filter(stock_id == "Loligo_gahi-41") %>%
  filter(year > 2007)

ggplot(argen_bbmsy, aes(x = year, y = bbmsy)) +
  geom_line() +
  theme_bw() +
  geom_hline(yintercept = 1.45, color = "darkgreen", lty = "dashed") +
  labs(y = "B/Bmsy",
       x = "Year",
       title = "Loligo gahi FAO area 41")
```
Here we can see that the fishery that accounts for 27% of the catch has a bbmsy that is steadily decreasing, meaning it is becoming more fully exploited... this could be why the Falkland Island scores are getting worse. 



Let's look at the African islands.

```{r}
Iles <- catch %>% 
  filter(rgn_id %in% c(35,36),
         year > 2008) %>%
  left_join(bbmsy) %>%
  group_by(year, rgn_id) %>%
  mutate(catch_prop = mean_catch/sum(mean_catch)) %>%
  left_join(rgn_deets)

plotly::ggplotly(ggplot(Iles, aes(year, catch_prop)) + 
  geom_area(aes(fill = stock_id)) +
  theme_bw() +
  theme(legend.position="") +
  facet_wrap(~rgn_nam))
```

Ok it looks like Tuna is a significant portion of catch for these islands.

```{r}

ile_catch <- Iles %>%
  filter(catch_prop > 0.1,
         !is.na(bbmsy))

ggplot(ile_catch, aes(x = year, y = bbmsy, color = stock_id)) +
  geom_line() +
  theme_bw() +
  labs(y = "B/Bmsy",
       x = "Year",
       ggtitle = "Tuna status for FAO 51") +
  theme(legend.title=element_blank())

```

Let's look at the Maldives

```{r}
maldives <- catch %>% 
  filter(rgn_id == 39,
         year > 2008) %>%
  left_join(bbmsy) %>%
  group_by(year) %>%
  mutate(catch_prop = mean_catch/sum(mean_catch)) %>%
  left_join(rgn_deets)

plotly::ggplotly(ggplot(maldives, aes(year, catch_prop)) + 
  geom_area(aes(fill = stock_id)) +
  theme_bw() +
  theme(legend.position=""))
```

Again *Katsuwonus pelamis* (Skipjack Tuna) is majority of catch.

Is Amsterdam Island also highly dependant on Skipjack? It's much more subpolar (near Antarctic)

```{r}
ams <- catch %>% 
  filter(rgn_id == 92,
         year > 2008) %>%
  left_join(bbmsy) %>%
  group_by(year) %>%
  mutate(catch_prop = mean_catch/sum(mean_catch)) %>%
  left_join(rgn_deets)

plotly::ggplotly(ggplot(ams, aes(year, catch_prop)) + 
  geom_area(aes(fill = stock_id)) +
  theme_bw() +
  theme(legend.position=""))

```

This time is *Thunnus albacares* (Yellowfin tuna) which has a similar trajectory to Skipjack.









